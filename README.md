# numeri

Lightweight analytics tool. No overkill, no fuss, just the essentials.  

A simple analytics API that lets you track events from your applications and retrieve the data later.  
Think of it as a lightweight alternative to complex analytics platforms: you send events, they get stored, you query them back.

## core functionality

**event tracking**  
Any event can be sent with custom properties to `/v1/track` and numeri will store it with automatic metadata like
geolocation, referrer, visitor and timestamp.

**event processing**  
Using Redis as bus, events are processed by a separate component to ensure fast response times and reliability.

**analytics retrieval**  
Analytics data can be queried from `/v1/analytics` with filtering, pagination, and sorting.

**clients management**  
New clients can register via `/v1/clients/register` using a code generated by an admin. Each client gets a unique API
key and secret pair for authentication.

## local development

1. **set up environment**:
   Create a `.env` file in the root directory with the following content:
   ```env
    NODE_ENV=dev
    LOG_LEVEL=debug
    REDIS_URL=redis://localhost:6379
    ADMIN_BEARER=your-admin-bearer-token
    ROOT_URL=http://localhost:3000
   ```

2. **install and run**:  
   Before running these commands, make sure you have a Redis server running locally.
   ```bash
   nvm use
   npm install
   npm run migrate:up
   npm run dev
   ```

3. **test the application**:
    ```bash
    curl http://localhost:3000/
    ```

## using the API

### 1. generate a registration code (admin only)

First, generate a one-time code for client registration:

```bash
curl -X POST http://localhost:3000/v1/codes \
  -H "Authorization: Bearer your-admin-bearer-token"
```

**response:**

```json
{
  "code": "a1b2c3d4e5f6...",
  "url": "http://localhost:3000/v1/clients/register?code=a1b2c3d4e5f6...",
  "expiresAt": "2025-09-09T12:00:00.000Z"
}
```

### 2. register a client

Use the one-time code to register a new client:

```bash
curl -X POST "http://localhost:3000/v1/clients/register?code=a1b2c3d4e5f6..." \
  -H "Content-Type: application/json" \
  -d '{
    "name": "My Website",
    "ownerEmail": "owner@example.com",
    "allowedOrigins": ["https://example.com", "https://www.example.com"]
  }'
```

**response:**

```json
{
  "apiKey": "550e8400-e29b-41d4-a716-446655440000",
  "secret": "abc123def456..."
}
```

Save both the `apiKey` and `secret`, you'll need them for tracking and analytics.

### 3. track events

Now you can start tracking events from your application using any custom event names and properties.

```bash
# views
curl -X POST http://localhost:3000/v1/track \
  -H "x-api-key: 550e8400-e29b-41d4-a716-446655440000" \
  -H "Content-Type: application/json" \
  -d '{
    "event": "page_view",
    "properties": {
      "page": "/dashboard",
    }
  }'

# clicks
curl -X POST http://localhost:3000/v1/track \
  -H "x-api-key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "event": "click",
    "properties": {
      "button_id": "subscribe",
      "page": "/pricing",
      "user_id": "user123"
    }
  }'

# purchase
curl -X POST http://localhost:3000/v1/track \
  -H "x-api-key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "event": "purchase",
    "properties": {
      "product_id": "pro-plan",
      "amount": 29.99,
      "currency": "USD",
      "user_id": "user123"
    }
  }'
```
Or, you can use the dedicated client (âœ¨) for easier integration: [numeri-client](https://github.com/manuelbent/numeri-client).

### 4. retrieve analytics

Query your tracked events:

```bash
# get all events (paginated)
curl "http://localhost:3000/v1/analytics?page=1&limit=10" \
  -H "x-secret-key: abc123def456..."

# filter by event type
curl "http://localhost:3000/v1/analytics?eventType=page_view" \
  -H "x-secret-key: your-secret"

# filter by event type and visitor ID
curl "http://localhost:3000/v1/analytics?eventType=click&visitorId=123e8430-e34b-94d6-a412-34942892761" \
  -H "x-secret-key: your-secret"
```

Currently, filtering is not supported on custom nested properties.

**response format:**

```json
[
  {
    "visitorId": "123e8430-e34b-94d6-a412-34942892761",
    "eventType": "page_view",
    "site": "https://example.com",
    "geolocation": {
      "continentCode": "EU",
      "countryName": "France",
      "countryCode": "FR",
      "region": "Brittany"
    },
    "countryCode": "FR",
    "timestamp": "2025-09-02T10:30:00.000Z",
    "properties": {
      "page": "/dashboard",
      "user_id": "user123",
      "session_id": "sess456"
    }
  }
]
```

## authentication

- **admin operations** (generating codes): `Authorization: Bearer {your-admin-bearer-token}`
- **client tracking** (sending events): `x-api-key: {client-api-key}`
- **client analytics** (retrieving data): `x-secret-key: {client-secret}`

## API overview

- `POST /v1/codes` Generate client registration codes
- `POST /v1/clients/register` Register new API clients
- `POST /v1/track` Track events
- `GET /v1/analytics` Retrieve processed events
